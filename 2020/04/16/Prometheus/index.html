<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="IT技术类博客，主要是运维方向(Docker、DevOPS、Golang等)"><title>基于Prometheus的监控平台 | 冒了个小小泡</title><link rel="stylesheet" type="text/css" href="/abitming.github.io/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/abitming.github.io/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/abitming.github.io/favicon.ico"><link rel="apple-touch-icon" href="/abitming.github.io/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/abitming.github.io/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于Prometheus的监控平台</h1><a id="logo" href="/abitming.github.io/.">冒了个小小泡</a><p class="description">小明的博客</p></div><div id="nav-menu"><a class="current" href="/abitming.github.io/."><i class="fa fa-home"> 首页</i></a><a href="/abitming.github.io/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/abitming.github.io/about/"><i class="fa fa-user"> 关于</i></a><a href="/abitming.github.io/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">基于Prometheus的监控平台</h1><div class="post-meta">Apr 16, 2020</div><div class="post-content"><h1 id="基于Prometheus的监控平台"><a href="#基于Prometheus的监控平台" class="headerlink" title="基于Prometheus的监控平台"></a>基于Prometheus的监控平台</h1><h2 id="一、环境部署"><a href="#一、环境部署" class="headerlink" title="一、环境部署"></a>一、环境部署</h2><h3 id="1、Prometheus-部署-官网"><a href="#1、Prometheus-部署-官网" class="headerlink" title="1、Prometheus 部署(官网)"></a>1、Prometheus 部署(<a href="https://prometheus.io/" target="_blank" rel="noopener">官网</a>)</h3><p>Prometheus的部署十分简单，从官方下载压缩文件之后，直接解压缩执行prometheus的二进制文件就OK了！</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml --web.enable-lifecycle --storage.tsdb.retention=<span class="number">30</span>d  --storage.tsdb.path=<span class="string">"data/"</span> --storage.tsdb.no-lockfile</span><br><span class="line">numprocs=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>Centos7 以下版本的系统可以使用 Supervisor管理进程。Centos 7 及以上使用 Systemd 就好！</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Supervisor 的子配置</span></span><br><span class="line"><span class="section">[program:prometheus]</span></span><br><span class="line"><span class="attr">command</span>= /data1/prometheus-<span class="number">2.5</span>/prometheus --config.file=prometheus.yml --web.enable-lifecycle --storage.tsdb.retention=<span class="number">30</span>d  --storage.tsdb.path=<span class="string">"data/"</span> --storage.tsdb.<span class="literal">no</span>-lockfile</span><br><span class="line"><span class="attr">numprocs</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">directory</span>=/data1/prometheus-<span class="number">2.5</span></span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">startretries</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">autorestart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">stdout_logfile</span>=/data1/www/logs/prometheus_access.log</span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">3</span>GB</span><br><span class="line"><span class="attr">stderr_logfile</span>=/data1/www/logs/prometheus_error.log</span><br><span class="line"><span class="attr">stderr_logfile_maxbytes</span>=<span class="number">3</span>GB</span><br></pre></td></tr></table></figure>
<p>线上 <strong>prometheus.yaml</strong> 配置参考：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">  scrape_timeout:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">30</span><span class="string">s</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># thanos 需要用到这个参数</span></span><br><span class="line"><span class="attr">  external_labels:</span></span><br><span class="line"><span class="attr">    monitor_idc:</span> <span class="string">bx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AlterManager 服务配置</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">["x.x.x.x:9093"]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># 普通节点配置</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'Prometheus-slave'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"x.x.x.x:9090"</span></span><br><span class="line"><span class="attr">        labels:</span></span><br><span class="line"><span class="attr">          instance:</span> <span class="string">x.x.x.x</span></span><br><span class="line"><span class="comment"># PushGetway 配置</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'Pushgateway'</span></span><br><span class="line"><span class="attr">    honor_labels:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">["pushgateway.com.cn"]</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># K8S APi 配置</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'Kubernetes-apiservers-bx'</span></span><br><span class="line"><span class="attr">    kubernetes_sd_configs:</span></span><br><span class="line"><span class="attr">      - role:</span> <span class="string">endpoints</span></span><br><span class="line"><span class="attr">        api_server:</span> <span class="string">'https://xxx.com.cn:6443'</span></span><br><span class="line"><span class="attr">        tls_config:</span></span><br><span class="line"><span class="attr">          ca_file:</span> <span class="string">/etc/ssl/k8s-bx/ca.pem</span></span><br><span class="line"><span class="attr">          cert_file:</span> <span class="string">/etc/ssl/k8s-bx/admin.pem</span></span><br><span class="line"><span class="attr">          key_file:</span> <span class="string">/etc/ssl/k8s-bx/admin-key.pem</span></span><br><span class="line"><span class="attr">    relabel_configs:</span></span><br><span class="line"><span class="attr">      - source_labels:</span> <span class="string">[__meta_kubernetes_namespace,</span> <span class="string">__meta_kubernetes_service_name,</span> <span class="string">__meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="attr">        action:</span> <span class="string">keep</span></span><br><span class="line"><span class="attr">        regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"><span class="attr">      - source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line"><span class="attr">        regex:</span> <span class="string">'(.*):6443'</span></span><br><span class="line"><span class="attr">        replacement:</span> <span class="string">'$&#123;1&#125;:8080'</span></span><br><span class="line"><span class="attr">        target_label:</span> <span class="string">__address__</span></span><br><span class="line"><span class="attr">      - source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line"><span class="attr">        action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        regex:</span> <span class="string">'(.*):8080'</span></span><br><span class="line"><span class="attr">        replacement:</span> <span class="string">'$&#123;1&#125;'</span></span><br><span class="line"><span class="attr">        target_label:</span> <span class="string">instance</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># Cadvisor 数据采集配置</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'Kubernetes-cadvisor'</span></span><br><span class="line"><span class="attr">    kubernetes_sd_configs:</span></span><br><span class="line"><span class="attr">      - api_server:</span> <span class="string">'https://k8.com.cn:6443'</span></span><br><span class="line"><span class="attr">        role:</span> <span class="string">node</span></span><br><span class="line"><span class="attr">        tls_config:</span></span><br><span class="line"><span class="attr">            ca_file:</span> <span class="string">/etc/ssl/k8s/ca.pem</span></span><br><span class="line"><span class="attr">            cert_file:</span> <span class="string">/etc/ssl/k8s/admin.pem</span></span><br><span class="line"><span class="attr">            key_file:</span> <span class="string">/etc/ssl/k8s/admin-key.pem</span></span><br><span class="line"><span class="attr">    relabel_configs:</span></span><br><span class="line"><span class="attr">      - action:</span> <span class="string">labelmap</span></span><br><span class="line"><span class="attr">        regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="attr">      - source_labels:</span> <span class="string">[__meta_kubernetes_role]</span></span><br><span class="line"><span class="attr">        action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        target_label:</span> <span class="string">kubernetes_role</span></span><br><span class="line"><span class="attr">      - source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line"><span class="attr">        regex:</span> <span class="string">'(.*):10250'</span></span><br><span class="line"><span class="attr">        replacement:</span> <span class="string">'$&#123;1&#125;:4194'</span></span><br><span class="line"><span class="attr">        target_label:</span> <span class="string">__address__</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># consul 动态发现配置</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'kube-state'</span></span><br><span class="line"><span class="attr">    consul_sd_configs:</span></span><br><span class="line"><span class="attr">      - server:</span> <span class="string">'consul.com.cn'</span></span><br><span class="line"><span class="attr">        services:</span> <span class="string">['kube-state']</span></span><br><span class="line"><span class="attr">    relabel_configs:</span></span><br><span class="line"><span class="attr">        - source_labels:</span> <span class="string">[__meta_consul_service_address]</span></span><br><span class="line"><span class="attr">          target_label:</span> <span class="string">instance</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># Etcd 监控配置</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'Etcd-2411集群'</span></span><br><span class="line"><span class="attr">    scheme:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">      - targets:</span> <span class="string">['e2411-1.xxx.com.cn:2411','e2411-2.xxx.com.cn:2411','e2411-3.xxx.com.cn:2411','e2411-4.xxx.com.cn:2411','e2411-5.xxx.com.cn:2411']</span></span><br><span class="line"><span class="attr">    relabel_configs:</span></span><br><span class="line"><span class="attr">      - source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line"><span class="attr">        action:</span> <span class="string">replace</span></span><br><span class="line"><span class="attr">        regex:</span> <span class="string">(.*):2411</span></span><br><span class="line"><span class="attr">        replacement:</span> <span class="string">$1</span></span><br><span class="line"><span class="attr">        target_label:</span> <span class="string">instance</span></span><br><span class="line"><span class="comment"># 告警规则设置</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"rules.yaml"</span></span><br></pre></td></tr></table></figure>
<p>线上 <strong>rule.yaml</strong> 配置参考：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一些PromQL</span></span><br><span class="line"><span class="comment">###### Etcd #####</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125;集群异常节点超过半数，集群不可用</span></span><br><span class="line"><span class="comment"># sum(up&#123;job=~"Etcd.*"&#125;)by(job) - count(up&#123;job=~"Etcd.*"&#125;)by(job)/2 &lt; 0</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125;集群的leader 异常，leader数：&#123;&#123; $value &#125;&#125;"</span></span><br><span class="line"><span class="comment">#  max(etcd_server_has_leader) by(job) != 1</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 集群出现异常！！！RPC(远程过程调用)的错误速率为：&#123;&#123; $value &#125;&#125;ops/秒</span></span><br><span class="line"><span class="comment"># ceil(sum(rate(grpc_server_handled_total&#123;grpc_type="unary",grpc_code!="OK"&#125;[5m])) by (job)) &gt; 500</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.instance &#125;&#125; 节点的数据库使用已经超过6G</span></span><br><span class="line"><span class="comment"># etcd_debugging_mvcc_db_total_size_in_bytes /1000000000 &gt;= 6</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 集群的每秒操作频繁，次数：&#123;&#123; $value &#125;&#125;ops/秒</span></span><br><span class="line"><span class="comment"># ceil(sum(rate(grpc_server_started_total&#123;grpc_type="unary"&#125;[1m])) by(job)) &gt; 20000</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 集群的查询操作频繁，次数：&#123;&#123; $value &#125;&#125;次/秒</span></span><br><span class="line"><span class="comment">#ceil(sum(grpc_server_started_total&#123;grpc_service="etcdserverpb.Watch",grpc_type="bidi_stream"&#125;)by (job) - sum(grpc_server_handled_total&#123;grpc_service="etcdserverpb.Watch",grpc_type="bidi_stream"&#125;) by(job)) &gt; 10000</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.instance &#125;&#125; 节点的内存使用已经超过8G</span></span><br><span class="line"><span class="comment"># ceil(process_resident_memory_bytes&#123;job=~"^Etcd.*"&#125; / 1000000000 ) &gt; 8</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 集群提交事务的失败速率超过10次/秒</span></span><br><span class="line"><span class="comment"># sum(rate(etcd_server_proposals_failed_total[1m])) by(job) &gt; 10</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 集群排队提交的提案数量超过50次，客户负载较高或成员无法提交提案</span></span><br><span class="line"><span class="comment"># sum(etcd_server_proposals_pending) by(job) &gt; 50</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.instance &#125;&#125; 节点客户端进流量为：&#123;&#123; $value &#125;&#125;Mb/s</span></span><br><span class="line"><span class="comment"># ceil(rate(etcd_network_client_grpc_received_bytes_total[1m])  / 1000000 * 8 ) &gt; 60</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.instance &#125;&#125; 节点客户端出流量为：&#123;&#123; $value &#125;&#125;Mb/s</span></span><br><span class="line"><span class="comment"># ceil(rate(etcd_network_client_grpc_sent_bytes_total[1m])  / 1000000 * 8 )  &gt; 100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####### Ceph ######</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 主节点个数</span></span><br><span class="line"><span class="comment"># ceph_monitor_quorum_count != 3</span></span><br><span class="line"><span class="comment"># &#123;&#123; $labels.job &#125;&#125; 集群状态：error</span></span><br><span class="line"><span class="comment"># ceph_health_status == 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###### Kubernetes ######</span></span><br><span class="line"><span class="comment"># k8s master节点-&#123;&#123; $labels.instance &#125;&#125; 每秒5xx数为：&#123;&#123; $value &#125;&#125;/s</span></span><br><span class="line"><span class="comment"># sum (rate(apiserver_request_count&#123;code=~"5..",job="Kubernetes-apiservers-bx"&#125;[1m])) by(instance) &gt; 5</span></span><br><span class="line"><span class="comment"># 当前的k8s-master节点数为：&#123;&#123; $value &#125;&#125;/(正常节点数为3)</span></span><br><span class="line"><span class="comment"># sum(up&#123;job="Kubernetes-apiservers-bx"&#125;) != 3</span></span><br><span class="line"><span class="comment"># K8s集群的CPU核心数使用率大于60%</span></span><br><span class="line"><span class="comment"># ceil(sum(kube_pod_container_resource_requests_cpu_cores&#123;job="bx-kube-state"&#125;) / sum(kube_node_status_allocatable_cpu_cores&#123;job="bx-kube-state"&#125;) * 100) &gt; 60</span></span><br><span class="line"><span class="comment"># K8s集群的Memory使用率大于60%</span></span><br><span class="line"><span class="comment"># ceil(sum(kube_pod_container_resource_requests_memory_bytes&#123;job="bx-kube-state"&#125;) / sum(kube_node_status_allocatable_memory_bytes&#123;job="bx-kube-state"&#125;) * 100) &gt; 60</span></span><br><span class="line"><span class="comment"># K8s集群的Pod使用率大于80%</span></span><br><span class="line"><span class="comment"># ceil(sum(kube_pod_info&#123;job="dbl-kube-state"&#125;) / sum(kube_node_status_allocatable_pods&#123;job="dbl-kube-state"&#125;) * 100) &gt; 80</span></span><br><span class="line"><span class="comment"># K8s 集群--&#123;&#123; $labels.pod_name &#125;&#125;容器,CPU使用过高，使用率：&#123;&#123; $value &#125;&#125;%</span></span><br><span class="line"><span class="comment"># ceil(sum (label_replace(label_replace(rate(container_cpu_usage_seconds_total&#123;pod_name != "",job="Kubernetes-cadvisor-bx",namespace=~"^dpool.*",container_name!="POD",&#125;[1m]),"node","$1","instance","(.*)"),"container","$1","container_name","(.*)")) by(pod_name,node,container) / avg(label_replace(kube_pod_container_resource_limits_cpu_cores&#123;job="bx-kube-state",namespace=~"^dpool.*"&#125;, "pod_name", "$1", "pod", "(.*)")) by (pod_name,node,container) * 100) &gt; 80</span></span><br><span class="line"><span class="comment"># k8s 集群--&#123;&#123; $labels.pod_name &#125;&#125;容器,内存使用过高，使用率：&#123;&#123; $value &#125;&#125;</span></span><br><span class="line"><span class="comment">#ceil(sum(label_replace(label_replace(container_memory_rss&#123;container_name!="",pod_name!="",container_name!="POD",job="Kubernetes-cadvisor-bx",namespace=~"^dpool.*"&#125;,"container","$1","container_name","(.*)"),"node","$1","instance","(.*)"))by(pod_name,container,node) / avg(label_replace(kube_pod_container_resource_limits_memory_bytes&#123;job="bx-kube-state",namespace=~"^dpool.*"&#125;,"pod_name","$1","pod","(.*)")) by(pod_name,container,node)*100) &gt; 90</span></span><br><span class="line"><span class="comment"># k8s Pending状态Pod</span></span><br><span class="line"><span class="comment"># sum(kube_pod_status_phase&#123;phase="Pending",job="kube-state",namespace=~"^dpol.*"&#125;) by(pod,namespace) == 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##### Node #####</span></span><br><span class="line"><span class="comment"># 物理机环境：cpu的使用率超过80</span></span><br><span class="line"><span class="comment"># ceil(100 - sum (rate(node_cpu_seconds_total&#123;job="Physical_exporter",mode=~"idle"&#125;[1m])) by (instance,role,zone) / sum (rate(node_cpu_seconds_total&#123;job="Physical_exporter"&#125;[1m])) by (instance,role,zone) *100) &gt; 80</span></span><br><span class="line"><span class="comment"># 物理机环境：cpu_load1(取整)大于 3</span></span><br><span class="line"><span class="comment"># ceil(sum(node_load1&#123;job="Physical_exporter"&#125;) by(instance,role,zone) / sum (node_cpu_logical_count&#123;job="Physical_exporter"&#125;) by(instance,role,zone)) &gt;= 3</span></span><br><span class="line"><span class="comment"># 物理机环境：网卡进流量大于800Mbps</span></span><br><span class="line"><span class="comment"># ceil(ceil(rate(node_network_receive_bytes_total&#123;job="Physical_exporter",device=~"eth.*"&#125;[1m]) * 8) / 1000000) &gt; 800</span></span><br><span class="line"><span class="comment"># 物理环境：网卡接收丢包数大于60个/min</span></span><br><span class="line"><span class="comment"># increase(node_network_receive_drop_total&#123;job="Physical_exporter",device=~"eth.*"&#125;[1m]) &gt; 60</span></span><br><span class="line"><span class="comment"># 物理环境：网卡发送丢包数大于60个/min</span></span><br><span class="line"><span class="comment"># increase(node_network_transmit_drop_total&#123;job="Physical_exporter",device=~"eth.*"&#125;[1m]) &gt; 60</span></span><br><span class="line"><span class="comment"># 物理机环境：重点目录使用率大于90%</span></span><br><span class="line"><span class="comment"># ceil( (node_filesystem_size_bytes&#123;job="Physical_exporter",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp",fstype !~ "tmpfs|rootfs"&#125; - node_filesystem_free_bytes&#123;job="Physical_exporter",fstype !~ "tmpfs|rootfs",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp"&#125;) / node_filesystem_size_bytes&#123;job="Physical_exporter",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp",fstype !~ "tmpfs|rootfs"&#125; * 100 ) &gt; 90</span></span><br><span class="line"><span class="comment"># 物理机环境：swap分区使用率大于90%</span></span><br><span class="line"><span class="comment"># ceil(100 - (node_memory_SwapFree_bytes&#123;job="Physical_exporter"&#125;/node_memory_SwapTotal_bytes&#123;job="Physical_exporter"&#125;)*100) &gt; 90</span></span><br><span class="line"><span class="comment"># 物理机环境：nf_conntrack使用率大于80%</span></span><br><span class="line"><span class="comment"># ceil(node_nf_conntrack_count&#123;job="Physical_exporter"&#125; / node_nf_conntrack_max&#123;job="Physical_exporter"&#125; * 100) &gt; 80</span></span><br><span class="line"><span class="comment"># 物理环境机器发生重启</span></span><br><span class="line"><span class="comment"># time() - node_boot_time_seconds&#123;job="Physical_exporter"&#125; &lt; 100</span></span><br><span class="line"><span class="comment"># 物理环境目录inodes使用率大于90%</span></span><br><span class="line"><span class="comment">#  ceil( (node_filesystem_files&#123;job="Physical_exporter",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp",fstype !~ "tmpfs|rootfs"&#125; - node_filesystem_files_free&#123;job="Physical_exporter",fstype !~ "tmpfs|rootfs",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp"&#125;) / node_filesystem_files&#123;job="Physical_exporter",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp",fstype !~ "tmpfs|rootfs"&#125; * 100 ) &gt; 90</span></span><br><span class="line"></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Physical_nodes</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">physical_nodes_system_restart</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">time()</span> <span class="bullet">-</span> <span class="string">node_boot_time_seconds&#123;job="Physical_exporter"&#125;</span> <span class="string">&lt;</span> <span class="number">100</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">"物理环境机器发生重启"</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">"&#123; \"etype\":\"HOST\",\"model\":\"System\",\"event\":\"Restart\",\"msg\":\"<span class="template-variable">&#123;&#123; $labels.role &#125;&#125;</span>-<span class="template-variable">&#123;&#123; $labels.zone &#125;&#125;</span>-<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>\" &#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - alert:</span> <span class="string">physical_nodes_inodes_usage</span></span><br><span class="line"><span class="attr">    expr:</span> <span class="string">ceil(</span> <span class="string">(node_filesystem_files&#123;job="Physical_exporter",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp",fstype</span> <span class="string">!~</span> <span class="string">"tmpfs|rootfs"</span><span class="string">&#125;</span> <span class="bullet">-</span> <span class="string">node_filesystem_files_free&#123;job="Physical_exporter",fstype</span> <span class="string">!~</span> <span class="string">"tmpfs|rootfs"</span><span class="string">,mountpoint=~"/|/data[0-9]|/var|/usr|/tmp"&#125;)</span> <span class="string">/</span> <span class="string">node_filesystem_files&#123;job="Physical_exporter",mountpoint=~"/|/data[0-9]|/var|/usr|/tmp",fstype</span> <span class="string">!~</span> <span class="string">"tmpfs|rootfs"</span><span class="string">&#125;</span> <span class="string">*</span> <span class="number">100</span> <span class="string">)</span> <span class="string">&gt; 90</span></span><br><span class="line"><span class="string"></span><span class="attr">    annotations:</span></span><br><span class="line"><span class="attr">      summary:</span> <span class="string">"物理环境目录inodes使用率大于90%"</span></span><br><span class="line"><span class="attr">      description:</span> <span class="string">"&#123; \"etype\":\"HOST\",\"model\":\"Disk\",\"event\":\"Inodes_usage\",\"project\":\"<span class="template-variable">&#123;&#123; $labels.role &#125;&#125;</span>\",\"idc\":\"<span class="template-variable">&#123;&#123; $labels.zone &#125;&#125;</span>\",\"dockerip\":\"\",\"hostip\":\"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>-<span class="template-variable">&#123;&#123; $labels.mountpoint &#125;&#125;</span>\",\"value\":<span class="template-variable">&#123;&#123; $value &#125;&#125;</span> &#125;"</span></span><br></pre></td></tr></table></figure>
<p>动态加载修改的配置文件：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:<span class="number">9090</span>/-/reload</span><br></pre></td></tr></table></figure>
<h3 id="2、AlterManager部署-官网"><a href="#2、AlterManager部署-官网" class="headerlink" title="2、AlterManager部署(官网)"></a>2、AlterManager部署(<a href="https://prometheus.io/docs/alerting/alertmanager/" target="_blank" rel="noopener">官网</a>)</h3><p>AlterManager的部署也十分简单，从官方下载压缩文件之后，直接解压缩执行二进制文件就OK了！</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./alertmanager --config.file=/<span class="keyword">data</span>1/alertmanager-<span class="number">0.16</span>.<span class="number">1</span>/alertmanager.yml</span><br></pre></td></tr></table></figure>
<p>线上 altermanager.yaml 配置参考：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  resolve_timeout:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="attr">  group_by:</span> <span class="string">['alertname']</span></span><br><span class="line"><span class="attr">  group_wait:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  group_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  repeat_interval:</span> <span class="number">15</span><span class="string">s</span></span><br><span class="line"><span class="attr">  receiver:</span> <span class="string">ops</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line"><span class="attr">- source_match_re:</span></span><br><span class="line"><span class="attr">    alertname:</span> <span class="string">'(bx|dbl)_k8s_node_status'</span></span><br><span class="line"><span class="attr">  target_match_re:</span></span><br><span class="line"><span class="attr">    alertname:</span> <span class="string">'(bx|dbl)_k8s_node_calico_status'</span></span><br><span class="line"><span class="attr">  equal:</span> <span class="string">['node_info']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里使用 WebHook 的方式发送报警</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">'ops'</span></span><br><span class="line"><span class="attr">  webhook_configs:</span></span><br><span class="line"><span class="attr">  - url:</span> <span class="string">'http://xxx.xxx:8080/api/alerts/hook'</span></span><br><span class="line"><span class="attr">    send_resolved:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>告警收敛触发逻辑：</p>
<p><img src="/abitming.github.io/2020/04/16/Prometheus/AlterManager.png" alt="AlterManager"></p>
<h2 id="二、高可用方案"><a href="#二、高可用方案" class="headerlink" title="二、高可用方案"></a>二、高可用方案</h2><h3 id="Thanos-GitHub和官网-–-Prometheus的高可用方案"><a href="#Thanos-GitHub和官网-–-Prometheus的高可用方案" class="headerlink" title="Thanos(GitHub和官网) – Prometheus的高可用方案"></a>Thanos(<a href="https://github.com/thanos-io/thanos" target="_blank" rel="noopener">GitHub</a>和<a href="https://thanos.io/getting-started.md/" target="_blank" rel="noopener">官网</a>) – Prometheus的高可用方案</h3><h3 id="1、Thanos-架构"><a href="#1、Thanos-架构" class="headerlink" title="1、Thanos 架构"></a>1、Thanos 架构</h3><p>Thanos 本身对Prometheus没有任何侵入性，采用Sidecar的方式实现数据的查询等功能。</p>
<p><img src="/abitming.github.io/2020/04/16/Prometheus/Thanos架构图.jpg" alt="Thanos架构图"></p>
<p>Thanos高版本抛弃了 cluser-peers 参数，采用 StoreApi 负责连接各个角色。</p>
<h3 id="2、Thanos-Sidecar-部署"><a href="#2、Thanos-Sidecar-部署" class="headerlink" title="2、Thanos-Sidecar 部署"></a>2、Thanos-Sidecar 部署</h3><p>在GitHub上下载压缩包，解压之后直接执行二进制文件。Sidecar的启动：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./thanos  sidecar --prometheus.url=<span class="string">"http://localhost:9090"</span> --http-address=<span class="string">"0.0.0.0:19191"</span> --grpc-address=<span class="string">"0.0.0.0:19090"</span></span><br></pre></td></tr></table></figure>
<p>其中 –http-address 是 Sidecar 暴露的 HTTP 端口，在浏览器中直接访问 http:// x.x.x.x:19191/metrics 是有数据返回的。–grpc-address 就是 StoreApi，这个地址要写到 Query 的参数中。</p>
<h3 id="3、Thanos-Query-部署"><a href="#3、Thanos-Query-部署" class="headerlink" title="3、Thanos-Query 部署"></a>3、Thanos-Query 部署</h3><p>在GitHub上下载压缩包，解压之后直接执行二进制文件。Query的启动：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./thanos query --http-address=<span class="string">"0.0.0.0:10902"</span> --store=x.x.x.x:<span class="number">19090</span> --store=y.y.y.y:<span class="number">19090</span> --query.replica-label=<span class="string">"monitor_test"</span></span><br></pre></td></tr></table></figure>
<p>其中 –store 参数 就是 Sidecar 的 –grpc-address。这里写了两个Sidecar的地址(也就是对应着两个 Prometheus 实例)。如果一个Prometheus实例出现无法访问的情况。访问 <a href="http://queryip:10902" target="_blank" rel="noopener">http://queryip:10902</a>  会出现警告错误。</p>
<h2 id="三、监控平台"><a href="#三、监控平台" class="headerlink" title="三、监控平台"></a>三、监控平台</h2><h3 id="1、监控平台模块"><a href="#1、监控平台模块" class="headerlink" title="1、监控平台模块"></a>1、监控平台模块</h3><p><img src="/abitming.github.io/2020/04/16/Prometheus/监控模块.png" alt="监控模块"></p>
<h3 id="2、监控平台架构"><a href="#2、监控平台架构" class="headerlink" title="2、监控平台架构"></a>2、监控平台架构</h3><p><img src="/abitming.github.io/2020/04/16/Prometheus/监控架构图.png" alt="监控架构图"></p>
</div><div class="tags"><a href="/abitming.github.io/tags/CNCF，Prometheus，Thanos，AlterManager/">CNCF，Prometheus，Thanos，AlterManager</a></div><div class="post-nav"><a class="pre" href="/abitming.github.io/2020/04/16/SRE/">SRE 运维解密</a><a class="next" href="/abitming.github.io/2020/04/09/Ceph那些事/">Ceph初探</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/abitming.github.io/tags/Linux，Docker/" style="font-size: 15px;">Linux，Docker</a> <a href="/abitming.github.io/tags/Ceph，存储/" style="font-size: 15px;">Ceph，存储</a> <a href="/abitming.github.io/tags/SRE、运维/" style="font-size: 15px;">SRE、运维</a> <a href="/abitming.github.io/tags/感想/" style="font-size: 15px;">感想</a> <a href="/abitming.github.io/tags/CNCF，Prometheus，Thanos，AlterManager/" style="font-size: 15px;">CNCF，Prometheus，Thanos，AlterManager</a> <a href="/abitming.github.io/tags/Varnish，Cache/" style="font-size: 15px;">Varnish，Cache</a> <a href="/abitming.github.io/tags/自述/" style="font-size: 15px;">自述</a> <a href="/abitming.github.io/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/abitming.github.io/tags/Golang/" style="font-size: 15px;">Golang</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2020/04/23/Sina/">Sina，江湖再见</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2020/04/16/SRE/">SRE 运维解密</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2020/04/16/Prometheus/">基于Prometheus的监控平台</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2020/04/09/Ceph那些事/">Ceph初探</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2020/04/09/varnish那些事/">Varnish缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2019/12/31/容器技术 - Docker网络/">容器技术 - Docker网络</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2019/12/23/容器技术 - Dockerfile/">容器技术 - Dockerfile</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2019/08/16/Linux的limit以及Docker的中的应用/">Linux的limit.conf以及在Docker中的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2019/05/05/白话golang并发/">白话Golang并发</a></li><li class="post-list-item"><a class="post-list-link" href="/abitming.github.io/2019/05/05/博客的开始/">关于我</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.docker.com" title="Docker官网" target="_blank">Docker官网</a><ul></ul><a href="https://kubernetes.io" title="Kubernetes官网" target="_blank">Kubernetes官网</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/abitming.github.io/." rel="nofollow">冒了个小小泡.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Abitming.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"></a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/abitming.github.io/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/abitming.github.io/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/abitming.github.io/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/abitming.github.io/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/abitming.github.io/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/abitming.github.io/js/smartresize.js?v=0.0.0"></script></div></body></html>